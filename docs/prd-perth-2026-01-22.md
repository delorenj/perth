# Product Requirements Document: Perth (33GOD IDE)

**Date:** 2026-01-22 (Updated: 2026-01-28)
**Author:** Jarad DeLorenzo
**Version:** 1.1
**Project Type:** Terminal IDE / Multiplexer Fork
**Project Level:** 2
**Status:** Active - Sprint 1 Complete

---

## Document Overview

This Product Requirements Document (PRD) defines the functional and non-functional requirements for the Zellij Fork, specifically tailored to become the primary IDE for the 33GOD ecosystem. It details the integration of `zdrive` capabilities, native agent notifications, and robust session persistence.

**Related Documents:**

- Architecture Document: [docs/architecture-perth-2026-01-22.md](architecture-perth-2026-01-22.md)
- Sprint Plan: [docs/sprint-plan-perth-2026-01-22.md](sprint-plan-perth-2026-01-22.md)
- Milestone 1 Acceptance: [docs/milestone-1-acceptance.md](milestone-1-acceptance.md)
- Sprint 1 Summary: [docs/sprint-1-summary.md](sprint-1-summary.md)

---

## Executive Summary

The goal is to transform a fork of Zellij into a specialized, "genic" IDE that natively supports the complex, multi-agent workflows of the 33GOD ecosystem. Current limitations in the plugin system and the external nature of `zdrive` (Zellij Driver) hinder the seamless experience required for managing dozens of concurrent agents. By moving these features into the core, we aim to enable rich visual notifications, robust CLI control, unbreakable session persistence via PostgreSQL, and ruVector for semantic cross-client search, effectively creating a "perfect" environment for interactive and non-interactive coding sessions.

---

## Product Goals

### Business Objectives

1.  **Seamless Agent Orchestration:** Eliminate the friction of managing multiple concurrent agents across panes and tabs.
2.  **Enhanced Observability:** Provide immediate, visual feedback on background agent activity to reduce context-switching latency.
3.  **Enhanced Auditability**: Ensure that session history is fully captured and searchable for compliance and debugging.
4.  **Robust Session Continuity:** Ensure that complex workspace states (dozens of agents/tasks) can be persisted and recovered reliably, protecting against data loss and setup time.

## Functional Requirements

Functional Requirements (FRs) define **what** the system does - specific features and behaviors.

---

### Core Features

#### FR-001: Native Visual Notifications

- **ID:** FR-001
- **Priority:** Must Have
- **Description:** The system shall visually highlight tabs and panes when a background task (e.g., an agent) triggers a notification.
- **Acceptance Criteria:**
    - A specific visual cue (e.g., color change, icon, border highlight) appears on the relevant tab/pane.
    - The cue persists until acknowledged or reset.
    - Support for animations (e.g., pulsing/flashing) to indicate urgency.

#### FR-002: Integrated CLI Control (ZDrive)

- **ID:** FR-002
- **Priority:** Must Have
- **Description:** CLI commands to create, name, and manage tabs and panes programmatically.
- **Acceptance Criteria:**
    - Commands to create tabs/panes with specific names/layouts.
    - Commands to close/rename specific tabs/panes.
    - Pane-first navigation by semantic name.
- **Implementation Note (Sprint 1):** Implemented as external `zdrive` CLI tool rather than embedded in Perth binary. This approach provides clean separation between context management (zdrive) and terminal primitives (Zellij). ZDrive uses Redis-backed state for metadata persistence and identifier-based session attachment. See [zdrive-integration-notes.md](zdrive-integration-notes.md) for details.

#### FR-003: Programmatic Input Injection

- **ID:** FR-003
- **Priority:** Must Have
- **Description:** The system shall allow injecting text input into any specific pane via CLI commands.
- **Acceptance Criteria:**
    - Command target specific pane ID.
    - Input text is sent as if typed by the user.
    - Support for sending control characters.

#### FR-004: Postgres-Backed Session Persistence

- **ID:** FR-004
- **Priority:** Must Have
- **Description:** Full session state, including pane layouts, command history, and active tab metadata, shall be persisted to a PostgreSQL database.
- **Acceptance Criteria:**
    - Real-time or periodic syncing of state to DB.
    - Ability to restore a session completely from DB records.
    - Schema supports capturing pane content/history.

#### FR-005: Advanced UI Animations

- **ID:** FR-005
- **Priority:** Should Have
- **Description:** A native animation system to support rich UI feedback for notifications and status changes.
- **Acceptance Criteria:**
    - Framework for defining frame-based animations for UI elements.
    - Low CPU overhead for running animations.

---

## Non-Functional Requirements

Non-Functional Requirements (NFRs) define **how** the system performs - quality attributes and constraints.

---

#### NFR-001: Performance Overhead

- **Description:** New native features (notifications, persistence) must not degrade the core terminal multiplexer performance.
- **Metric:** Input latency increase < 5ms.

#### NFR-002: Compatibility

- **Description:** Must maintain backward compatibility with standard Zellij configuration and layouts where possible.
- **Metric:** Existing layouts load without errors.

#### NFR-003: Database Reliability

- **Description:** Session persistence must handle database connection failures gracefully without crashing the IDE.
- **Metric:** System continues to function (with warning) if DB is unreachable.

---

## Epics

Epics are logical groupings of related functionality that will be broken down into user stories during sprint planning (Phase 4).

### Epic 1: Native Notification System

**Description:** Implement the core rendering engine changes and event loop modifications to support per-pane and per-tab visual notifications and animations.
**FRs:** FR-001, FR-005

### Epic 2: Core Control Integration

**Description:** Port and integrate `zdrive` logic directly into `zellij-server` and `zellij-client` to expose robust CLI control and input injection.
**FRs:** FR-002, FR-003

### Epic 3: Database Persistence Layer

**Description:** Design and implement the PostgreSQL schema and synchronization logic to persist session state and history.
**FRs:** FR-004, NFR-003

---

## User Stories (High-Level)

1.  **As a** Developer, **I want** to see a flashing red border on a pane **so that** I know my long-running build has failed without switching tabs.
2.  **As an** Agent Orchestrator, **I want** to programmatically spawn a new named tab for a specific task **so that** I can isolate agent contexts automatically.
3.  **As a** User, **I want** my session to automatically save to the database **so that** I can reboot my machine and pick up exactly where I left off, including scrollback.
4.  **As a** Script, **I want** to send a command to a specific running pane **so that** I can automate interactions within the IDE.

---

## User Personas

1.  **The Architect (Delorenj):** Manages complex, multi-agent workflows. Needs high observability and automation. Values stability and state recovery above all.
2.  **The Agent:** An automated entity that interacts with the IDE via CLI, spawning tasks and reporting status.

---

## User Flows

### Notification Flow

1.  Background agent finishes task.
2.  Agent sends CLI command: `zellij notify --pane-id <id> --style error`.
3.  Zellij server receives command.
4.  Zellij client renders flashing red border on target pane and corresponding tab.
5.  User focuses pane; notification clears.

### Recovery Flow

1.  User starts Zellij with `zellij attach --restore-from-db <session_id>`.
2.  Zellij connects to Postgres.
3.  Zellij reconstructs layout, tabs, and panes.
4.  Zellij populates pane scrollback from history records.
5.  Session is ready for interaction.

---

## Dependencies

### Internal Dependencies

- `zellij-server`: Core logic modification.
- `zellij-client`: Rendering logic modification.
- `zellij-utils`: Shared structs for messages.

### External Dependencies

- **PostgreSQL**: Required for session persistence.
- **Rust Toolchain**: For building the fork.

---

## Assumptions

- The existing Zellij codebase is modular enough to allow deep hooks into the rendering pipeline without a complete rewrite.
- `zdrive` logic can be cleanly ported to Rust/internal logic.

---

## Out of Scope

- Support for other database backends (SQLite/MySQL) in MVP.
- A public plugin API for these new features (initially internal-only).

---

## Open Questions

- ~~How will the database connection be configured securely?~~ **Resolved:** Database connection configured via `DATABASE_URL` environment variable or `~/.config/zellij/config.yaml` (chmod 600).
- What is the performance impact of serializing full scrollback history to the DB in real-time? **Deferred:** Scrollback persistence deferred to post-Milestone 1; current implementation focuses on session/tab/pane metadata.
- Should identifier-based session attachment (yiid, plane_ticket_id, bloodbank_correlation_id) be formalized in the schema? See [zdrive-integration-notes.md](zdrive-integration-notes.md).

---

## Approval & Sign-off

### Stakeholders

- **Product Owner:** Delorenj
- **Lead Developer:** 33GOD Agent

### Approval Status

- [ ] Product Owner
- [ ] Engineering Lead

---

## Revision History

| Version | Date       | Author | Changes     |
| ------- | ---------- | ------ | ----------- |
| 1.0     | 2026-01-22 | 33GOD  | Initial PRD |
| 1.1     | 2026-01-28 | 33GOD  | Updated status, added related docs, updated FR-002 with external zdrive implementation approach, resolved open questions |

---

## Next Steps

### Phase 3: Architecture

Run `/architecture` to create system architecture based on these requirements.

### Phase 4: Sprint Planning

After architecture is complete, run `/sprint-planning` to break epics into detailed user stories.

---

**This document was created using BMAD Method v6 - Phase 2 (Planning)**
